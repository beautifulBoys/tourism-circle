{"version":3,"sources":["../../src/controller/friend.js"],"names":["addFriendFunc","req","res","fromId","headers","userid","toId","body","to","remark","send","code","message","data","findOne","userId","friend","list","indexOf","status","type","obj","update","_id","value","multi","create","id","console","log","deleteFriendFunc","fromObj","friendList","concat","n","splice","err","toObj","fromobj","i","length","item","address","join","email","username","desc","postNum","sex","push","friendHandleFunc","meId","messageId","friendFromObj","newFrindList_from","friendToObj","newFrindList_to","find","result","myFriendFunc","user","avatar"],"mappings":"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","file":"friend.js","sourcesContent":["\r\nimport User from '../model/user.js';\r\nimport Message from '../model/message.js';\r\nimport Friend from '../model/friend.js';\r\nimport Id from '../model/id.js';\r\n\r\nexport const addFriendFunc = async (req, res) => {\r\n  let fromId = req.headers.userid - 0;\r\n  let toId = req.body.to - 0;\r\n  let remark = req.body.remark;\r\n  if (fromId === toId) {\r\n    res.send({code: 300, message: '不能添加自己为好友', data: {}});\r\n    return;\r\n  }\r\n  // 判断是否已经是好友\r\n  let friend = await Friend.findOne({userId: fromId});\r\n  if (friend.list.indexOf(toId) !== -1) {\r\n    res.send({code: 300, message: '你们已经是好友', data: {}});\r\n    return;\r\n  }\r\n  // 判断是否已经发送过请求了\r\n  friend = await Message.findOne({fromId: fromId, toId: toId, status: true, type: 'add-friend'});\r\n  if (friend) {\r\n    res.send({code: 300, message: '您已经对该用户发送过好友请求，请等待回复', data: {}});\r\n    return;\r\n  }\r\n\r\n  try {\r\n    let obj = await Id.findOne({type: 'messageId'});\r\n    if (obj) await Id.update({_id: obj._id}, {value: obj.value + 1}, {multi: false}, () => {});\r\n    else await Id.create({type: 'messageId'});\r\n    obj = await Id.findOne({type: 'messageId'});\r\n    await Message.create({\r\n      id: obj.value + 1,\r\n      type: 'add-friend',\r\n      fromId: fromId,\r\n      toId: toId,\r\n      remark: remark\r\n    });\r\n    res.send({code: 200, message: '添加好友请求发送成功', data: {}});\r\n  } catch (err) {\r\n    console.log(err);\r\n    res.send({code: 300, message: '添加好友请求发送失败', data: err});\r\n  }\r\n};\r\n\r\n\r\nexport const deleteFriendFunc = async (req, res) => {\r\n  let fromId = req.headers.userid - 0;\r\n  let toId = req.body.id - 0;\r\n  console.log(fromId, toId);\r\n  try {\r\n    let fromObj = await Friend.findOne({userId: fromId});\r\n    let friendList = fromObj.list.concat([]);\r\n    let n = friendList.indexOf(toId);\r\n    if (n !== -1) friendList.splice(n, 1);\r\n    Friend.update({userId: fromId}, {list: friendList}, {multi: false}, (err) => {});\r\n    \r\n    let toObj = await Friend.findOne({userId: toId});\r\n    friendList = toObj.list.concat([]);\r\n    n = friendList.indexOf(fromId);\r\n    if (n !== -1) friendList.splice(n, 1);\r\n    Friend.update({userId: toId}, {list: friendList}, {multi: false}, (err) => {});\r\n\r\n    let list = [];\r\n    let fromobj = await Friend.findOne({userId: fromId});\r\n\r\n    for (let i = 0; i < fromobj.list.length; i++) {\r\n      let friend = await User.findOne({id: fromobj.list[i] - 0});\r\n      \r\n      let item = {\r\n        address: friend.address.length > 0 ? friend.address.join('-') : '未设置',\r\n        email: friend.email || '未设置',\r\n        id: friend.id,\r\n        username: friend.username,\r\n        desc: friend.desc || '未设置',\r\n        postNum: friend.postNum\r\n      };\r\n      if (friend.sex === 1) item.sex = '女孩';\r\n      else if (friend.sex === 2) item.sex = '男孩';\r\n      else item.sex = '未设置';\r\n      list.push(item);\r\n    }\r\n    res.send({code: 200, message: '解除好友关系成功', data: {list}});\r\n  } catch (err) {\r\n    res.send({code: 300, message: '解除好友关系失败', data: err});\r\n  }\r\n  \r\n};\r\n\r\n\r\n\r\nexport const friendHandleFunc = async (req, res) => { // 处理好友请求\r\n  let meId = req.headers.userid;\r\n  let messageId = req.body.messageId - 0;\r\n  let fromId = req.body.fromId - 0;\r\n  let toId = req.body.toId - 0;\r\n  let type;\r\n  await Message.update({id: messageId}, {status: false}, {multi: false}, (err) => {});\r\n\r\n  if (req.body.type === 'agree') {\r\n    try {\r\n      let friendFromObj = await Friend.findOne({userId: fromId});\r\n      let newFrindList_from = friendFromObj.list.concat([]);\r\n      newFrindList_from.push(toId);\r\n      await Friend.update({userId: fromId}, {list: newFrindList_from}, {multi: false}, (err) => {\r\n        if (err) console.log(1, err);\r\n      });\r\n      \r\n      let friendToObj = await Friend.findOne({userId: toId});\r\n      let newFrindList_to = friendToObj.list.concat([]);\r\n      newFrindList_to.push(fromId);\r\n      await Friend.update({userId: toId}, {list: newFrindList_to}, {multi: false}, (err) => {\r\n        if (err) console.log(2, err);\r\n      });\r\n\r\n      let result = await Message.find({toId: meId});\r\n      let list = [];\r\n      for (let i = 0; i < result.length; i++) {\r\n        if (result[i].status) list.push(result[i]);\r\n      }\r\n      res.send({code: 200, message: '已添加好友', data: list});\r\n    } catch (err) {\r\n      console.log(err);\r\n      res.send({code: 300, message: '添加好友失败', data: err});\r\n    }\r\n  } else {\r\n    res.send({code: 200, message: '已拒绝', data: {}});\r\n  }\r\n};\r\n\r\n\r\nexport const myFriendFunc = async (req, res) => {\r\n  let userId = req.headers.userid;\r\n  let list = [];\r\n  try {\r\n    let user = await Friend.findOne({userId: userId});\r\n    for (let i = 0; i < user.list.length; i++) {\r\n      let friend = await User.findOne({id: user.list[i] - 0});\r\n      \r\n      let item = {\r\n        address: friend.address.length > 0 ? friend.address.join('-') : '',\r\n        email: friend.email,\r\n        id: friend.id,\r\n        username: friend.username,\r\n        desc: friend.desc,\r\n        postNum: friend.postNum,\r\n        avatar: friend.avatar,\r\n        sex: friend.sex\r\n      };\r\n      list.push(item);\r\n    }\r\n   \r\n    res.send({code: 200, message: '获取用户列表成功', data: {list: list}});\r\n  } catch (err) {\r\n    res.send({code: 300, message: '获取用户列表失败', data: err});\r\n  }\r\n};"]}