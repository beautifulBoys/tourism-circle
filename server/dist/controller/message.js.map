{"version":3,"sources":["../../src/controller/message.js"],"names":["typeToText","type","arr","messageBoxListFunc","req","res","find","toId","headers","userid","status","result","filter","item","i","length","findOne","id","fromId","user","obj","messageId","name","username","time","formatCSTDate","remark","typeText","push","send","code","message","data","list","ignoreMessageFunc","body","meId","update","multi","err","docs","console","log","sendWebMailFunc","to","_id","value","create","webMailSendFunc"],"mappings":"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","file":"message.js","sourcesContent":["\r\nimport Message from '../model/message.js';\r\nimport User from '../model/user.js';\r\nimport Id from '../model/id.js';\r\nimport util from '../lib/formDate.js';\r\n\r\nfunction typeToText (type) {\r\n  let arr = {\r\n    'add-friend': '好友请求',\r\n    'web-mail': '站内信'\r\n  };\r\n  return arr[type];\r\n}\r\n\r\nexport const messageBoxListFunc = async (req, res) => {\r\n  try {\r\n    let result = await Message.find({toId: req.headers.userid, status: true});\r\n    result = result.filter(item => item.status);\r\n    // res.send({code: 200, message: '获取消息盒子数据成功', data: {list: result}});\r\n    let arr = [];\r\n    for (let i = 0; i < result.length; i++) {\r\n      let user = await User.findOne({id: result[i].fromId});\r\n      let obj = {\r\n        messageId: result[i].id,\r\n        fromId: result[i].fromId,\r\n        toId: result[i].toId,\r\n        name: user.username,\r\n        time: util.formatCSTDate(result[i].time, 'MM/dd hh:mm'),\r\n        remark: result[i].remark,\r\n        typeText: typeToText(result[i].type),\r\n        type: result[i].type\r\n      };\r\n      arr.push(obj);\r\n    }\r\n    res.send({code: 200, message: '获取消息盒子数据成功', data: {list: arr}});\r\n  } catch (err) {\r\n    res.send({code: 300, message: '获取消息盒子数据失败', data: err});\r\n  }\r\n};\r\n\r\n\r\n\r\nexport const ignoreMessageFunc = async (req, res) => {\r\n  let messageId = req.body.id - 0;\r\n  let meId = req.headers.userid - 0;\r\n  try {\r\n    await Message.update({id: messageId}, {status: false}, {multi: false}, (err, docs) => {\r\n      if (err) {\r\n        console.log(err);\r\n        res.send({code: 300, message: '发生未知错误，忽略消息失败', data: {err, docs}});\r\n        return;\r\n      }\r\n      console.log(docs);\r\n    });\r\n\r\n    res.send({code: 200, message: '忽略消息成功', data: {}});\r\n  } catch (err) {\r\n    res.send({code: 300, message: '忽略消息失败，请联系管理员', data: err});\r\n  }\r\n};\r\n\r\nexport const sendWebMailFunc = async (req, res) => {\r\n  let fromId = req.headers.userid - 0;\r\n  let toId = req.body.to - 0;\r\n  let remark = req.body.remark;\r\n  if (fromId === toId) {\r\n    res.send({code: 300, message: '不能给自己发送站内信', data: {}});\r\n    return;\r\n  }\r\n  try {\r\n    let obj = await Id.findOne({type: 'messageId'});\r\n    if (obj) Id.update({_id: obj._id}, {value: obj.value + 1}, {multi: false}, () => {});\r\n    else Id.create({type: 'messageId'});\r\n    await Message.create({\r\n      id: obj.value + 1,\r\n      type: 'web-mail',\r\n      fromId: fromId,\r\n      toId: toId,\r\n      remark: remark\r\n    });\r\n    res.send({code: 200, message: '站内信发送成功', data: {}});\r\n  } catch (err) {\r\n    console.log(err);\r\n    res.send({code: 300, message: '站内信发送失败', data: err});\r\n  }\r\n};\r\n\r\n\r\n\r\n\r\n\r\nexport const webMailSendFunc = async (req, res) => {\r\n  let messageId = req.body.messageId - 0;\r\n  let remark = req.body.remark;\r\n  let fromId = req.body.fromId - 0;\r\n  let toId = req.body.toId - 0;\r\n  console.log(messageId, remark, fromId, toId);  \r\n  try {\r\n    await Message.update({id: messageId}, {fromId: toId, toId: fromId, remark: remark}, {multi: false}, (err) => {\r\n      if (err) console.log(err);\r\n    });\r\n    res.send({code: 200, message: '站内信发送成功', data: {}});\r\n  } catch (err) {\r\n    console.log(err);\r\n    res.send({code: 300, message: '站内信发送失败', data: err});\r\n  }\r\n};"]}