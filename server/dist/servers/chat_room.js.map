{"version":3,"sources":["../../src/servers/chat_room.js"],"names":["text","fn","ajax","result","JSON","parse","errObj","autoChat","app","require","http","Server","io","content","qingyunkeUrl","socketList","resolve","reject","httpApi","get","encodeURI","req","setEncoding","on","data","e","err","module","exports","socket","obj","userId","fromId","push","console","log","username","length","emit","filter","item","broadcast","toId","message","sign","me","type","i","port","listen"],"mappings":"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","file":"chat_room.js","sourcesContent":["\r\nvar app = require('express')();\r\nvar http = require('http').Server(app);\r\nvar io = require('socket.io')(http);\r\nimport chatRobot from './chat_robot.js';\r\n\r\nconst errObj = {\r\n  result: 0,\r\n  content: '没有理解你的意思，你能说的简单一点吗？'\r\n};\r\nconst qingyunkeUrl = 'http://api.qingyunke.com/api.php?key=free&appid=0&msg=';\r\n\r\nlet socketList = [];\r\nfunction ajax (text) {\r\n  return new Promise((resolve, reject) => {\r\n    try {\r\n      httpApi.get(qingyunkeUrl + encodeURI(text), (req) => {\r\n        req.setEncoding('utf8');\r\n        req.on('data', function (data) {\r\n          resolve(data);\r\n        });\r\n        req.on('error', (e) => {\r\n          resolve(errObj);\r\n        });\r\n      });\r\n    } catch (err) {\r\n      resolve(errObj);\r\n    }\r\n  });\r\n}\r\nasync function autoChat (text, fn) {\r\n  try {\r\n    let result = await ajax(text);\r\n    fn(JSON.parse(result));\r\n  } catch (err) {\r\n    fn(errObj);\r\n  }\r\n}\r\nmodule.exports = function () {\r\n  io.on('connection', socket => {\r\n\r\n    //监听新上线用户\r\n    socket.on('online', function (obj) {\r\n      this.userId = obj.fromId - 0;\r\n      socketList.push(socket);\r\n      console.log(obj.username + '（' + obj.fromId + '）' + ' 加入，现在在线人数: ', socketList.length);\r\n      this.emit('onlined', {userId: this.userId});\r\n    });\r\n\r\n    //监听用户退出\r\n    socket.on('disconnect', function () { // {userId: 1004}\r\n      socketList = socketList.filter((item) => {\r\n        if (item.userId - 0 === this.userId) console.log(item.userId + '退出');\r\n        return (item.userId - 0 !== this.userId);\r\n      });\r\n      console.log('现在在线人数: ', socketList.length);\r\n      this.broadcast.emit('logout', {userId: this.userId});\r\n    });\r\n\r\n    //监听用户发布聊天内容\r\n    socket.on('message', function (obj) { // {fromId, toId, message}\r\n      console.log('收到 '+ obj.fromId + ' 发送给 ' + obj.toId + ' 的消息： ' + obj.message);\r\n      let sign = true;\r\n      let me = this;\r\n      if (obj.toId - 0 === 100) {\r\n        console.log('收到发给机器人的消息');\r\n        chatRobot(obj.message, (result) => {\r\n          me.emit('message', {\r\n            fromId: obj.toId,\r\n            toId: obj.fromId,\r\n            type: 1,\r\n            message: result.content\r\n          });\r\n        });\r\n        return;\r\n      }\r\n      for (let i = 0; i < socketList.length; i++) {\r\n        if (obj.toId - 0 === socketList[i].userId - 0) {\r\n          sign = false;\r\n          socketList[i].emit('message', {\r\n            fromId: obj.fromId,\r\n            toId: obj.toId,\r\n            type: 1,\r\n            message: obj.message\r\n          });\r\n          break;\r\n        }\r\n      }\r\n      if (sign) {\r\n        this.emit('message', { // 对话方不在线。\r\n          fromId: obj.toId,\r\n          toId: obj.fromId,\r\n          type: 2,\r\n          message: '对方不在线，请稍后联系他'\r\n        });\r\n      }\r\n    });\r\n\r\n  });\r\n  let port = 5003;\r\n  http.listen(port, function () {\r\n    console.log('聊天工具启动: ' + port);\r\n  });\r\n};\r\n"]}